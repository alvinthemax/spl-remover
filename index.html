<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Solana Token Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
  <script src="https://unpkg.com/@solana/spl-token@latest/lib/index.iife.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 1rem;
      background: #f2f2f2;
      color: #333;
    }

    button {
      padding: 10px 16px;
      margin: 5px 0;
      background: #6200ea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    button:hover {
      background: #3700b3;
    }

    input {
      padding: 8px;
      margin-bottom: 10px;
      width: 100%;
      box-sizing: border-box;
    }

    .token-card {
      background: white;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .token-actions {
      margin-top: 8px;
    }

    @media (max-width: 600px) {
      h2 {
        font-size: 1.4rem;
      }

      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <h2>Solana Token Manager</h2>
  <button onclick="connectWallet()">Connect Phantom Wallet</button>
  <p id="wallet-address">Wallet not connected</p>

  <h3>My Tokens</h3>
  <div id="token-list">Connect wallet to view tokens</div>

  <script>
    const {
      Connection,
      PublicKey,
      clusterApiUrl,
      Transaction,
    } = solanaWeb3;

    const {
      getParsedAccountInfo,
      getAccount,
      getAssociatedTokenAddress,
      closeAccount,
      burn,
    } = splToken;

    const connection = new Connection(clusterApiUrl('mainnet-beta'), "confirmed");
    let wallet = null;

    async function connectWallet() {
      if (window.solana && window.solana.isPhantom) {
        try {
          const resp = await window.solana.connect();
          wallet = window.solana;
          document.getElementById("wallet-address").textContent = "Connected: " + resp.publicKey.toString();
          fetchTokenAccounts();
        } catch (err) {
          alert("Wallet connection failed.");
        }
      } else {
        alert("Please install Phantom Wallet!");
      }
    }

    async function fetchTokenAccounts() {
      const tokenListDiv = document.getElementById("token-list");
      tokenListDiv.innerHTML = "Loading tokens...";

      const accounts = await connection.getParsedTokenAccountsByOwner(wallet.publicKey, {
        programId: new PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA")
      });

      tokenListDiv.innerHTML = "";
      for (const { pubkey, account } of accounts.value) {
        const info = account.data.parsed.info;
        const tokenAmount = info.tokenAmount.uiAmount;
        const mint = info.mint;

        const tokenDiv = document.createElement("div");
        tokenDiv.className = "token-card";
        tokenDiv.innerHTML = `
          <strong>Token:</strong> ${mint}<br>
          <strong>Balance:</strong> ${tokenAmount}
          <div class="token-actions"></div>
        `;

        const actionDiv = tokenDiv.querySelector(".token-actions");

        // Burn Button (if balance > 0)
        if (tokenAmount > 0) {
          const burnBtn = document.createElement("button");
          burnBtn.textContent = "Burn Token";
          burnBtn.onclick = () => burnToken(mint, pubkey, tokenAmount);
          actionDiv.appendChild(burnBtn);
        }

        // Close Button (only if balance === 0)
        if (tokenAmount === 0) {
          const closeBtn = document.createElement("button");
          closeBtn.textContent = "Close Account";
          closeBtn.onclick = () => closeTokenAccount(pubkey);
          actionDiv.appendChild(closeBtn);
        }

        tokenListDiv.appendChild(tokenDiv);
      }
    }

    async function burnToken(mintAddress, tokenAccountPubkey, amount) {
      try {
        const mint = new PublicKey(mintAddress);
        const user = wallet.publicKey;

        const tx = new Transaction().add(
          splToken.burn({
            account: tokenAccountPubkey,
            mint,
            owner: user,
            amount: BigInt(Math.floor(amount)), // Must be BigInt
          })
        );

        const { blockhash } = await connection.getLatestBlockhash();
        tx.recentBlockhash = blockhash;
        tx.feePayer = user;

        const signed = await wallet.signTransaction(tx);
        const sig = await connection.sendRawTransaction(signed.serialize());
        await connection.confirmTransaction(sig);
        alert("Token burned: " + sig);
        fetchTokenAccounts();
      } catch (err) {
        console.error(err);
        alert("Failed to burn token: " + err.message);
      }
    }

    async function closeTokenAccount(tokenAccountPubkey) {
      try {
        const user = wallet.publicKey;

        const tx = new Transaction().add(
          splToken.closeAccount({
            source: tokenAccountPubkey,
            destination: user,
            owner: user,
          })
        );

        const { blockhash } = await connection.getLatestBlockhash();
        tx.recentBlockhash = blockhash;
        tx.feePayer = user;

        const signed = await wallet.signTransaction(tx);
        const sig = await connection.sendRawTransaction(signed.serialize());
        await connection.confirmTransaction(sig);
        alert("Closed token account: " + sig);
        fetchTokenAccounts();
      } catch (err) {
        console.error(err);
        alert("Failed to close account: " + err.message);
      }
    }
  </script>
</body>
</html>